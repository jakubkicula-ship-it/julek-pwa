<!DOCTYPE html>
<html lang="pl">
<head><!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Zadania Julka">

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Punkty Julka</title>

<style>
  * { box-sizing: border-box; }

  body{
    font-family: Arial, sans-serif;
    margin: 16px;
    background: linear-gradient(180deg, #f3fff4 0%, #ffffff 55%, #ffffff 100%);
  }

  button{
    margin: 4px;
    padding: 10px 12px;
    border: 1px solid #ccc;
    background: #f7f7f7;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
  }
  button:hover { background: #eee; }
  button[disabled]{ opacity:.45; cursor:not-allowed; }

  .panel { display:none; }
  .hidden { display:none !important; }

  h1{
    margin: 8px 0 12px;
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  h2, h3 { margin: 14px 0 8px; }
  hr { margin: 16px 0; }

  .box{
    border: 1px solid #ddd;
    border-radius: 16px;
    padding: 16px;
    margin: 12px 0;
    background: #fff;
    box-shadow: 0 10px 26px rgba(0,0,0,.06);
  }
  .row{ display:flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .muted{ color:#666; font-size: 12px; }
  ul{ padding-left: 18px; }
  li{ margin: 6px 0; }

  .tag{
    display:inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #ddd;
    font-size: 12px;
    background: #fff;
  }

  .smallbtn{
    padding: 7px 10px;
    font-size: 12px;
    border-radius: 10px;
  }

  /* przycisk odwo≈Ça≈Ñ */
  .btnGreen { background:#eaffea; border-color:#7ccc7c; }
  .btnGreen:hover { background:#dcffdc; }
  .btnRed { background:#ffe8e8; border-color:#e09a9a; }
  .btnRed:hover { background:#ffdcdc; }

  /* statusy odwo≈Ça≈Ñ */
  .stPending { background:#fff7d6; border-color:#e3c77a; }
  .stAccepted { background:#eaffea; border-color:#7ccc7c; }
  .stRejected { background:#ffe8e8; border-color:#e09a9a; }
  .stCancelled { background:#f1f1f1; border-color:#cfcfcf; }

  /* komunikat weekendowy */
  .weekInfo { margin-top: 10px; padding: 10px; border-radius: 12px; border: 1px dashed #cfcfcf; background:#fff; }
  .weekMsgText { font-weight: 700; font-size: 14px; }
  .weekMsgTextBig { font-weight: 800; font-size: 18px; }

  /* ADMIN */
  .adminBox { border-color:#bde5bd; background:#f5fff5; }
  .adminTitleRow { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }

  /* ===== DASHBOARD (start) ===== */
  .dashWrap{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: 14px;
    margin-top: 10px;
  }
  .tile{
    border-radius: 18px;
    padding: 18px 16px;
    border: 1px solid rgba(0,0,0,.08);
    box-shadow: 0 10px 26px rgba(0,0,0,.08);
    cursor:pointer;
    user-select:none;
    transition:.18s;
    background:#fff;
    text-align:left;
  }
  .tile:hover{ transform: translateY(-2px); }
  .tileIcon{ font-size: 34px; line-height: 1; }
  .tileTitle{ font-weight: 900; margin-top: 8px; font-size: 16px; }
  .tileDesc{ margin-top: 6px; font-size: 12px; color:#666; }
  .tJulek{ background: #e3f7ff; }
  .tRodzic{ background: #eaffea; }
  .tPdf{ background: #fff3cd; }

  /* ===== BANER AKTUALIZACJI (TYLKO PC) ===== */
  #updateBanner{
    position:fixed;
    top:0; left:0; right:0;
    padding: 12px 14px;
    background:#fff3cd;
    border-bottom: 2px solid #f0ad4e;
    z-index: 12000;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    font-weight: 800;
  }
  #updateBanner button{
    background:#f0ad4e;
    border:0;
  }

  /* ===== PIN modal (≈Çadniejsze i nic nie wystaje) ===== */
  .modalOverlay{
    position:fixed; inset:0;
    background:rgba(20,20,20,.45);
    display:flex; align-items:center; justify-content:center;
    z-index:9999;
    padding: 16px;
    backdrop-filter: blur(1.5px);
  }
  .modalCard{
    background:#fff;
    border:1px solid #e6e6e6;
    border-radius:16px;
    padding:18px 18px 14px;
    width:min(440px, 100%);
    box-shadow:0 16px 55px rgba(0,0,0,.28);
    overflow:hidden;
  }
  .modalTitle{
    font-weight:800;
    font-size:18px;
    margin-bottom:8px;
    line-height:1.2;
  }
  .modalHint{
    color:#666;
    font-size:12px;
    margin: 0 0 10px;
  }
  .modalCard input{
    width:100%;
    padding:12px 14px;
    border:1px solid #d6d6d6;
    border-radius:12px;
    font-size:18px;
    outline:none;
    background:#fff;
  }
  .modalCard input:focus{
    border-color:#2e7d32;
    box-shadow: inset 0 0 0 3px rgba(46,125,50,.14);
  }
  .modalActions{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    margin-top:12px;
  }
  .modalActions button{
    padding:9px 14px;
    border-radius:12px;
  }
</style>
</head>

<body>

<!-- ===== BANER AKTUALIZACJI (PC) ===== -->
<div id="updateBanner" class="hidden">
  <span>üîÑ Nowa wersja aplikacji ‚Äì od≈õwie≈º</span>
  <button onclick="forceDesktopUpdate()">Od≈õwie≈º teraz</button>
</div>

<h1>
  Punkty Julka
  <span id="appVer" class="tag"></span>
</h1>

<!-- ===== START (DASHBOARD) ===== -->
<div id="login" class="box">
  <div class="muted">Wybierz kafelek:</div>

  <div class="dashWrap">
    <div class="tile tJulek" onclick="loginJulek()">
      <div class="tileIcon">üë¶</div>
      <div class="tileTitle">Julek</div>
      <div class="tileDesc">PodglƒÖd punkt√≥w i odwo≈Çania</div>
    </div>

    <div class="tile tRodzic" onclick="loginRodzic()">
      <div class="tileIcon">üë®‚Äçüë©‚Äçüë¶</div>
      <div class="tileTitle">Rodzic</div>
      <div class="tileDesc">Dodawanie/odejmowanie godzin</div>
    </div>

    <div class="tile tPdf" onclick="openPdf('UMOWA_JULEK_system_godzin.pdf')">
      <div class="tileIcon">üìÑ</div>
      <div class="tileTitle">Regulamin (PDF)</div>
      <div class="tileDesc">Do odczytu</div>
    </div>

    <div class="tile tPdf" onclick="openPdf('TABELA_PUNKTOW_JULEK.pdf')">
      <div class="tileIcon">üìä</div>
      <div class="tileTitle">Tabela punkt√≥w (PDF)</div>
      <div class="tileDesc">Do odczytu</div>
    </div>
  </div>

  <div class="muted" style="margin-top:12px;">
    PINy dzia≈ÇajƒÖ lokalnie w tej stronie. RESET jest tylko w zmianach administracyjnych Kuby.
  </div>
</div>

<!-- PIN modal (maskowane) -->
<div id="pinModal" class="modalOverlay hidden" hidden>
  <div class="modalCard">
    <div id="pinTitle" class="modalTitle">PIN</div>
    <div class="modalHint">Wpis jest maskowany (gwiazdki).</div>
    <input id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
    <div class="modalActions">
      <button id="pinCancel" class="smallbtn">Anuluj</button>
      <button id="pinOk" class="smallbtn">OK</button>
    </div>
  </div>
</div>

<!-- ================= PANEL RODZIC ================= -->
<div id="rodzic" class="panel">

  <div class="box">
    <div><b>Zalogowany rodzic:</b> <span id="rodzicName"></span></div>
    <div class="muted">Dzi≈õ: <b><span id="todayR">0</span> h</b> ¬∑ Tydzie≈Ñ: <b><span id="weekR">0</span> h</b> ¬∑ Weekend: <b><span id="weekendR">0</span> h</b></div>
    <div class="row" style="margin-top:8px;">
      <button id="btnAdmin" class="hidden" onclick="openAdmin()">Zmiany administracyjne</button>
      <span class="muted">Auto-zamkniƒôcie: piƒÖtek 18:00 (Warszawa) ‚Äî wykona siƒô, gdy kto≈õ ma otwartƒÖ apkƒô albo wejdzie po czasie.</span>
    </div>
  </div>

  <div class="box">
    <h3>Menu</h3>
    <div class="row">
      <button onclick="showSection('secUzn')">Godziny uznaniowe</button>
      <button onclick="showSection('secOceny')">Oceny</button>
      <button onclick="showSection('secObow')">ObowiƒÖzki i zachowanie</button>
      <button onclick="showSection(null)">Zwi≈Ñ wszystko</button>

      <button id="btnAppeals" class="btnGreen" onclick="toggleAppeals()">
        Odwo≈Çania i historia <span id="appealsBadge" class="tag">0</span>
      </button>
    </div>

    <div id="weekendInfoParent" class="weekInfo hidden">
      <div id="weekendInfoTextParent" class="weekMsgText"></div>
      <div id="weekendInfoDateParent" class="muted"></div>
    </div>
  </div>

  <div id="secAdmin" class="box adminBox hidden">
    <div class="adminTitleRow">
      <h3 style="margin:0;">Zmiany administracyjne</h3>
      <span class="muted">Dostƒôp tylko dla Kuby (PIN wymagany przy wej≈õciu).</span>
    </div>

    <div class="row" style="margin-top:10px;">
      <button onclick="zamknijTydzien()">Zamknij tydzie≈Ñ</button>

      <button class="btnRed" onclick="resetAllDataFromAdmin()">RESET (start od zera)</button>

      <button class="btnGreen" onclick="saveAndCloseAdmin()">Zapisz i zamknij zmiany administracyjne</button>
    </div>

    <div class="muted" style="margin-top:8px;">
      RESET jest dostƒôpny tylko tutaj. Dodatkowo wymaga ponownego PINu Kuby.
    </div>
  </div>

  <div id="secUzn" class="box hidden">
    <h3>Godziny uznaniowe (komentarz obowiƒÖzkowy)</h3>
    <div class="row">
      <button onclick="uzn(1)">+1h</button>
      <button onclick="uzn(2)">+2h</button>
      <button onclick="uzn(-1)">-1h</button>
      <button onclick="uzn(-2)">-2h</button>
    </div>
    <div class="muted">Po klikniƒôciu musisz wpisaƒá: za co.</div>
  </div>

  <div id="secOceny" class="box hidden">
    <h3>Oceny</h3>

    <div class="box">
      <h3 style="margin-top:0;">Polski</h3><div id="polski"></div>
      <h3>Biologia</h3><div id="biologia"></div>
      <h3>Geografia</h3><div id="geografia"></div>
    </div>

    <div class="box">
      <h3 style="margin-top:0;">WF</h3><div id="wf"></div>
      <h3>Technika</h3><div id="technika"></div>
      <h3>Muzyka</h3><div id="muzyka"></div>
      <h3>Informatyka</h3><div id="informatyka"></div>
      <h3>Plastyka</h3><div id="plastyka"></div>
    </div>

    <div class="box">
      <h3 style="margin-top:0;">Matematyka</h3><div id="matematyka"></div>
      <h3>Angielski</h3><div id="angielski"></div>
      <h3>Niemiecki</h3><div id="niemiecki"></div>
      <h3>Historia</h3><div id="historia"></div>
    </div>

    <div class="muted">Tu dzia≈Ça ostrze≈ºenie, je≈õli drugi rodzic ju≈º da≈Ç punkty za ten sam przedmiot i ocenƒô tego samego dnia.</div>
  </div>

  <div id="secObow" class="box hidden">
    <h3>ObowiƒÖzki / Zachowanie (komentarz opcjonalny)</h3>
    <div class="row">
      <button onclick="obow( 1,'ObowiƒÖzki zrobione', 'obow_ok', false)">ObowiƒÖzki zrobione +1h</button>

      <button onclick="obow( 4,'Pozytywna uwaga w szkole', 'uwaga_pos', false)">Pozytywna uwaga w szkole +4h</button>
      <button onclick="obow(-4,'Negatywna uwaga w szkole', 'uwaga_neg', false)">Negatywna uwaga w szkole -4h</button>

      <button onclick="obow(-2,'ObowiƒÖzki niezrobione', 'obow_no', false)">ObowiƒÖzki niezrobione -2h</button>
      <button onclick="obow(-10,'Oszustwo', 'oszustwo', false)">Oszustwo -10h</button>

      <button onclick="obow(-5,'Bicie / obra≈ºanie Micha≈Ça', 'agresja', true)">Bicie/obra≈ºanie Micha≈Ça -5h</button>
      <button onclick="obow(-2,'Brak higieny', 'higiena', true)">Brak higieny -2h</button>
      <button onclick="obow(-2,'PorzƒÖdek w pokoju niezrobiony', 'pokoj', true)">PorzƒÖdek w pokoju -2h</button>
    </div>
    <div class="muted">Komentarz opcjonalny: po klikniƒôciu mo≈ºesz dopisaƒá szczeg√≥≈Ç. Dublety sprawdzamy tylko dla agresji/higieny/pokoju.</div>
  </div>

  <div class="box">
    <h3>Aktualny tydzie≈Ñ ‚Äì log (rodzic)</h3>
    <div class="muted">Usuwanie: tylko wpisy z dzisiaj i tylko autor wpisu (drugi rodzic ma przycisk nieaktywny).</div>
    <ul id="logR"></ul>
  </div>

  <div id="secAppeals" class="box hidden">
    <h3>Odwo≈Çania Julka (rodzic) + historia</h3>
    <div class="muted">Decyzja do ko≈Ñca nastƒôpnego dnia. Po terminie odwo≈Çanie auto-zaakceptowane.</div>
    <div id="odwolaniaRodzic"></div>
  </div>

</div>

<!-- ================= PANEL JULEK ================= -->
<div id="julek" class="panel">
  <div class="box">
    <div class="muted">Dzi≈õ: <b><span id="todayJ">0</span> h</b> ¬∑ Tydzie≈Ñ: <b><span id="weekJ">0</span> h</b> ¬∑ Weekend: <b><span id="weekendJ">0</span> h</b></div>
  </div>

  <div id="weekendInfoJulek" class="box hidden">
    <div id="weekendInfoTextJulek" class="weekMsgTextBig"></div>
    <div id="weekendInfoDateJulek" class="muted"></div>
  </div>

  <div class="box">
    <h3>Aktualny tydzie≈Ñ ‚Äì za co</h3>
    <ul id="logJ"></ul>
    <div class="muted">Odwo≈Çanie: tylko od punkt√≥w ujemnych, tylko w dniu przyznania i tylko raz na wpis.</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
/* ================== WERSJA ================== */
const APP_VERSION = "1.0.1";
(function(){
  const v = document.getElementById("appVer");
  if(v) v.innerText = "v" + APP_VERSION;
})();

/* ================== BANER AKTUALIZACJI (TYLKO PC) ================== */
(function(){
  const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
  if(isMobile) return;

  const KEY = "julek_app_version";
  const old = localStorage.getItem(KEY);
  if(old && old !== APP_VERSION){
    const b = document.getElementById("updateBanner");
    if(b) b.classList.remove("hidden");
  }
  localStorage.setItem(KEY, APP_VERSION);
})();

function forceDesktopUpdate(){
  // PC: odpinamy service workery (≈ºeby przesta≈Çy mieszaƒá) i twardy reload
  if("serviceWorker" in navigator){
    navigator.serviceWorker.getRegistrations().then(regs=>{
      regs.forEach(r=>r.unregister());
    }).finally(()=>{
      location.reload(true);
    });
  } else {
    location.reload(true);
  }
}

/* ================== FIREBASE ================== */
firebase.initializeApp({
  apiKey:"AIzaSyD5asqQ2YEr_7LB9ysmyP_tZBj515-NW1o",
  authDomain:"julek-punkty.firebaseapp.com",
  databaseURL:"https://julek-punkty-default-rtdb.europe-west1.firebasedatabase.app"
});
const db = firebase.database();

/* ================== PDF ================== */
function openPdf(file){
  const w = window.open(file, "_blank");
  if(!w) location.href = file;
}

/* ================== CZAS (EUROPE/WARSAW) ================== */
function nowWarsawParts() {
  const d = new Date();
  const fmt = new Intl.DateTimeFormat('pl-PL', {
    timeZone: 'Europe/Warsaw',
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit',
    hour12:false, weekday:'short'
  });
  const parts = fmt.formatToParts(d);
  const get = (t)=>parts.find(p=>p.type===t)?.value;
  const year = Number(get('year'));
  const month = Number(get('month'));
  const day = Number(get('day'));
  const hour = Number(get('hour'));
  const minute = Number(get('minute'));
  const second = Number(get('second'));
  const weekday = get('weekday');
  const isoDate = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
  return {year,month,day,hour,minute,second,weekday,isoDate};
}
const dzis = nowWarsawParts().isoDate;

function isoDateShift(baseIso, days){
  const dt = new Date(`${baseIso}T12:00:00Z`);
  dt.setUTCDate(dt.getUTCDate() + days);
  return dt.toISOString().slice(0,10);
}
function endOfNextDayDeadlineDay() {
  return isoDateShift(dzis, 1);
}

/* ISO week key */
function isoWeekKeyWarsaw() {
  const p = nowWarsawParts();
  const dt = new Date(`${p.isoDate}T12:00:00Z`);
  const t = new Date(Date.UTC(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate()));
  const dayNum = t.getUTCDay() || 7;
  t.setUTCDate(t.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(t.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((t - yearStart) / 86400000) + 1) / 7);
  return `${t.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
}

/* ================== PIN MODAL (maskowane) ================== */
function showPinModal(title){
  const modal  = document.getElementById("pinModal");
  const ttl    = document.getElementById("pinTitle");
  const input  = document.getElementById("pinInput");
  ttl.innerText = title || "PIN:";
  input.value = "";
  modal.hidden = false;
  modal.classList.remove("hidden");
  setTimeout(()=>input.focus(), 0);
}
function hidePinModal(){
  const modal = document.getElementById("pinModal");
  modal.classList.add("hidden");
  modal.hidden = true;
}
function askPinMasked(title){
  const input  = document.getElementById("pinInput");
  const okBtn  = document.getElementById("pinOk");
  const noBtn  = document.getElementById("pinCancel");

  showPinModal(title);

  return new Promise(resolve=>{
    const close = (val)=>{
      hidePinModal();
      input.onkeydown = null;
      okBtn.onclick = null;
      noBtn.onclick = null;
      resolve(val);
    };

    okBtn.onclick = ()=> close(input.value);
    noBtn.onclick = ()=> close(null);

    input.onkeydown = (e)=>{
      if(e.key === "Enter") okBtn.click();
      if(e.key === "Escape") noBtn.click();
    };
  });
}

/* ================== UI / LOGOWANIE ================== */
let rodzic = "";
const loginBox = document.getElementById("login");
const rodzicDiv = document.getElementById("rodzic");
const julekDiv = document.getElementById("julek");

function expectedPinForRodzic(){
  if(rodzic === "Kuba") return "6978";
  if(rodzic === "Marlena") return "986";
  return "";
}

/* ADMIN: zapis zmian */
let adminDraft = {};
async function saveAndCloseAdmin(){
  if(rodzic !== "Kuba") return;
  await db.ref("meta/adminSettings").update({
    ...adminDraft,
    lastSavedAt: Date.now(),
    lastSavedBy: rodzic,
    appVersion: APP_VERSION
  });
  adminDraft = {};
  const sec = document.getElementById("secAdmin");
  if(sec) sec.classList.add("hidden");
}

async function openAdmin(){
  if(rodzic !== "Kuba") return;
  const pin = await askPinMasked("PIN (Zmiany administracyjne):");
  if(pin === null) return;

  if(pin !== expectedPinForRodzic()){
    alert("Z≈Çy PIN");
    return;
  }
  const sec = document.getElementById("secAdmin");
  if(sec){
    sec.classList.toggle("hidden");
    if(!sec.classList.contains("hidden")){
      sec.scrollIntoView({behavior:"smooth", block:"start"});
    }
  }
}

async function loginRodzic(){
  const pin = await askPinMasked("PIN:");
  if(pin === null) return;

  if(pin==="6978") rodzic="Kuba";
  else if(pin==="986") rodzic="Marlena";
  else return alert("Z≈Çy PIN");

  loginBox.style.display="none";
  rodzicDiv.style.display="block";
  document.getElementById("rodzicName").innerText = rodzic;

  const btnA = document.getElementById("btnAdmin");
  const secA = document.getElementById("secAdmin");
  if(btnA){
    if(rodzic === "Kuba") btnA.classList.remove("hidden");
    else btnA.classList.add("hidden");
  }
  if(secA) secA.classList.add("hidden");

  renderAll();

  purgeOldData();
  processAutoAcceptAppeals();
  checkAutoClose();
}
function loginJulek(){
  loginBox.style.display="none";
  julekDiv.style.display="block";
  renderAll();
  purgeOldData();
  processAutoAcceptAppeals();
  checkAutoClose();
}

function showSection(id){
  ["secUzn","secOceny","secObow"].forEach(x=>{
    const el = document.getElementById(x);
    if(el) el.classList.add("hidden");
  });
  if(id) document.getElementById(id).classList.remove("hidden");
}

function toggleAppeals(){
  const sec = document.getElementById("secAppeals");
  if(!sec) return;
  sec.classList.toggle("hidden");
}

/* ================== MAPY OCEN ================== */
const oceny1={np:-2,1:-3,2:-2,3:-0.5,4:1,5:2,6:3};
const oceny2={np:-1,bs:-1,1:-2,2:-3,3:-0.5,4:1,5:1.5,6:2};
const oceny3={np:-1,1:-3,2:-3,3:-2,4:1,5:3,6:4};

/* ================== ZAPIS / DUBLETY ================== */
async function hasDuplicateToday(category){
  const snap = await db.ref("log/"+dzis).once("value");
  let found = null;
  snap.forEach(ch=>{
    const v = ch.val();
    if(v && v.category === category && v.rodzic && v.rodzic !== rodzic){
      found = {key: ch.key, v};
    }
  });
  return found;
}

async function zapis(h, opis, category, checkDuplicate){
  if(!rodzic) return alert("Najpierw zaloguj rodzica.");
  if(checkDuplicate){
    const dup = await hasDuplicateToday(category);
    if(dup){
      const msg =
        `Uwaga: wyglƒÖda na to, ≈ºe ${dup.v.rodzic} ju≈º doda≈Ç/a dzisiaj punkty za to samo:\n`+
        `${dup.v.opis} (${dup.v.h>0?'+':''}${dup.v.h}h)\n\n`+
        `Czy na pewno chcesz dodaƒá DRUGI raz?`;
      if(!confirm(msg)) return;
    }
  }

  const txt = `${opis} (${rodzic})`;
  const ts = Date.now();

  await db.ref("dni/"+dzis).transaction(v=>(v||0)+h);
  await db.ref("log/"+dzis).push({
    h, opis: txt, rodzic,
    category: category || "",
    ts
  });
}

/* ================== GODZINY UZNANIOWE ================== */
function uzn(h){
  const t = prompt("Za co? (wymagane)");
  if(!t || t.trim().length < 3) return alert("Wpisz sensowny opis (min. 3 znaki).");
  zapis(h, "Uznaniowe: "+t.trim(), "uzn", false);
}

/* ================== OBOW / ZACH ================== */
function obow(h, label, category, checkDuplicate){
  let note = prompt("Dodatkowy komentarz? (opcjonalnie)\nMo≈ºesz zostawiƒá puste.");
  note = (note || "").trim();
  const full = note ? `${label}: ${note}` : label;
  zapis(h, full, category, checkDuplicate);
}

/* ================== GENERATORY OCEN ================== */
function genGrades(containerId, subject, map){
  const el = document.getElementById(containerId);
  if(!el) return;
  const wrap = document.createElement("div");
  wrap.className="row";
  for(let k in map){
    const b=document.createElement("button");
    b.innerText = k;
    b.onclick = () => {
      const h = map[k];
      const label = `${subject} ‚Äì ocena ${k}`;
      const category = `grade:${subject}:${k}`;
      zapis(h, label, category, true);
    };
    wrap.appendChild(b);
  }
  el.appendChild(wrap);
}
genGrades("polski","Polski",oceny1);
genGrades("biologia","Biologia",oceny1);
genGrades("geografia","Geografia",oceny1);

genGrades("wf","WF",oceny2);
genGrades("technika","Technika",oceny2);
genGrades("muzyka","Muzyka",oceny2);
genGrades("informatyka","Informatyka",oceny2);
genGrades("plastyka","Plastyka",oceny2);

genGrades("matematyka","Matematyka",oceny3);
genGrades("angielski","Angielski",oceny3);
genGrades("niemiecki","Niemiecki",oceny3);
genGrades("historia","Historia",oceny3);

/* ================== PODSUMOWANIA ================== */
db.ref("dni").on("value",s=>{
  let t = s.child(dzis).val()||0, w=0;
  s.forEach(d=>w+= (d.val()||0));
  setText("todayR", t); setText("todayJ", t);
  setText("weekR", w); setText("weekJ", w);
});

db.ref("weekend").on("value",s=>{
  const v = s.val()||0;
  setText("weekendR", v);
  setText("weekendJ", v);
});

/* ================== WEEKEND SUMMARY ================== */
db.ref("meta/weekendSummary").on("value", s=>{
  renderWeekendSummary(s.val());
});

function fmtHoursAbs(h){
  const n = Math.abs(Number(h||0));
  return (n % 1 === 0) ? String(n) : String(n).replace(".", ",");
}
function buildWeekendText(hours){
  const n = Number(hours||0);
  if(n > 0) return `Julek mo≈ºe korzystaƒá z komputera ${fmtHoursAbs(n)} godzin przez ca≈Çy weekend.`;
  if(n < 0) return `Julek ma wykonywaƒá obowiƒÖzki zadane przez rodzic√≥w przez ${fmtHoursAbs(n)} godzin w ten weekend.`;
  return `Weekend bez dodatkowych godzin (0h).`;
}
function tsToWarsaw(ts){
  if(!ts) return "";
  return new Date(ts).toLocaleString("pl-PL", { timeZone: "Europe/Warsaw" });
}
function renderWeekendSummary(v){
  const pBox = document.getElementById("weekendInfoParent");
  const pText = document.getElementById("weekendInfoTextParent");
  const pDate = document.getElementById("weekendInfoDateParent");

  const jBox = document.getElementById("weekendInfoJulek");
  const jText = document.getElementById("weekendInfoTextJulek");
  const jDate = document.getElementById("weekendInfoDateJulek");

  if(!v){
    if(pBox) pBox.classList.add("hidden");
    if(jBox) jBox.classList.add("hidden");
    return;
  }

  const text = v.text || buildWeekendText(v.hours||0);
  const when = v.generatedAt ? `Wygenerowano: ${tsToWarsaw(v.generatedAt)}` : "";

  if(pBox && pText && pDate){
    pText.innerText = text;
    pDate.innerText = when;
    pBox.classList.remove("hidden");
  }
  if(jBox && jText && jDate){
    jText.innerText = text;
    jDate.innerText = when;
    jBox.classList.remove("hidden");
  }
}

async function setWeekendSummary(hours, weekKey, reason){
  const payload = {
    hours: Number(hours||0),
    text: buildWeekendText(hours),
    generatedAt: Date.now(),
    weekKey: weekKey || "",
    reason: reason || ""
  };
  await db.ref("meta/weekendSummary").set(payload);
}

/* ================== CACHE ================== */
let logsCache = {};
let appealsByLog = {};
let appealsList = [];

db.ref("log").on("value", s=>{
  logsCache = {};
  s && s.forEach(day=>{
    const date = day.key;
    logsCache[date] = {};
    day.forEach(item=>{
      logsCache[date][item.key] = item.val();
    });
  });
  renderAll();
});

db.ref("odwolania").on("value", s=>{
  appealsByLog = {};
  appealsList = [];

  s && s.forEach(ch=>{
    const o = ch.val();
    if(!o) return;
    const key = ch.key;
    const date = o.data || "";
    const logId = o.logId || "";
    if(date && logId){
      const idx = `${date}|${logId}`;
      const cur = appealsByLog[idx];
      if(!cur || (o.createdAt||0) > (cur.createdAt||0)){
        appealsByLog[idx] = {...o, key};
      }
    }
    appealsList.push({...o, key});
  });

  appealsList.sort((a,b)=>{
    const ap = (a.status||"") === "pending";
    const bp = (b.status||"") === "pending";
    if(ap !== bp) return ap ? -1 : 1;
    const at = (a.decyzjaAt||a.createdAt||0);
    const bt = (b.decyzjaAt||b.createdAt||0);
    return bt - at;
  });

  updateAppealsButton();
  renderAll();
});

/* ================== RENDER ================== */
function renderAll(){
  renderParentLogs();
  renderJulekLogs();
  renderParentAppeals();
  updateAppealsButton();
}

function sortedDates(obj){
  return Object.keys(obj||{}).sort();
}

function statusLabelForAppeal(o){
  if(!o) return "";
  const st = (o.status||"").toLowerCase();
  if(st==="pending") return "w toku";
  if(st==="accepted") return "zaakceptowane";
  if(st==="accepted_auto") return "zaakceptowane automatycznie z powodu braku rozpatrzenia przez rodzica w umownym czasie";
  if(st==="rejected") return "niezaakceptowane";
  if(st==="cancelled") return "anulowane";
  return st || "";
}

function appealClass(o){
  const st = (o.status||"").toLowerCase();
  if(st==="pending") return "stPending";
  if(st==="accepted" || st==="accepted_auto") return "stAccepted";
  if(st==="rejected") return "stRejected";
  if(st==="cancelled") return "stCancelled";
  return "stPending";
}

function renderParentLogs(){
  const ul = document.getElementById("logR");
  if(!ul) return;
  ul.innerHTML = "";

  const dates = sortedDates(logsCache);
  if(dates.length === 0){
    const li = document.createElement("li");
    li.innerText = "Brak wpis√≥w w aktualnym tygodniu.";
    ul.appendChild(li);
    return;
  }

  dates.forEach(date=>{
    const dayObj = logsCache[date] || {};
    const keys = Object.keys(dayObj).sort((a,b)=>(dayObj[a]?.ts||0)-(dayObj[b]?.ts||0));
    if(keys.length === 0) return;

    const header = document.createElement("li");
    header.innerHTML = `<b>${date}</b>`;
    ul.appendChild(header);

    const inner = document.createElement("ul");
    inner.style.paddingLeft = "18px";

    keys.forEach(logId=>{
      const v = dayObj[logId];
      if(!v) return;
      const sign = (v.h>0?"+":"");
      const txt = `${v.opis} (${sign}${v.h}h)`;

      const li = document.createElement("li");
      li.appendChild(document.createTextNode(txt+" "));

      const del = document.createElement("button");
      del.className = "smallbtn";
      del.innerText = "Usu≈Ñ";

      if(!rodzic){
        del.disabled = true;
        del.title = "Zaloguj siƒô jako rodzic.";
      } else if(date !== dzis){
        del.disabled = true;
        del.title = "Mo≈ºna usuwaƒá tylko dzisiejsze wpisy.";
      } else if(v.rodzic !== rodzic){
        del.disabled = true;
        del.title = "Mo≈ºe usunƒÖƒá tylko autor wpisu.";
      } else {
        del.onclick = ()=>usunWpisDzis(date, logId, v);
      }

      li.appendChild(del);
      inner.appendChild(li);
    });

    ul.appendChild(inner);
  });
}

function renderJulekLogs(){
  const ul = document.getElementById("logJ");
  if(!ul) return;
  ul.innerHTML = "";

  const dates = sortedDates(logsCache);
  if(dates.length === 0){
    const li = document.createElement("li");
    li.innerText = "Brak wpis√≥w w aktualnym tygodniu.";
    ul.appendChild(li);
    return;
  }

  dates.forEach(date=>{
    const dayObj = logsCache[date] || {};
    const keys = Object.keys(dayObj).sort((a,b)=>(dayObj[a]?.ts||0)-(dayObj[b]?.ts||0));
    if(keys.length === 0) return;

    const header = document.createElement("li");
    header.innerHTML = `<b>${date}</b>`;
    ul.appendChild(header);

    const inner = document.createElement("ul");
    inner.style.paddingLeft = "18px";

    keys.forEach(logId=>{
      const v = dayObj[logId];
      if(!v) return;

      const sign = (v.h>0?"+":"");
      const appeal = appealsByLog[`${date}|${logId}`] || null;
      const st = statusLabelForAppeal(appeal);

      const baseTxt = `${v.opis} (${sign}${v.h}h)`;
      const li = document.createElement("li");
      li.appendChild(document.createTextNode(baseTxt+" "));

      if(appeal){
        const span = document.createElement("span");
        span.className = "tag " + appealClass(appeal);
        span.innerText = `Status: ${st}`;
        li.appendChild(span);
        li.appendChild(document.createTextNode(" "));

        if((appeal.status||"") === "rejected" && appeal.komentarz){
          const comm = document.createElement("div");
          comm.className = "muted";
          comm.style.marginTop = "4px";
          comm.innerText = "Komentarz rodzica: " + appeal.komentarz;
          li.appendChild(comm);
        }
      }

      const btn = document.createElement("button");
      btn.className = "smallbtn";
      btn.innerText = appeal ? "Odwo≈Çane" : "Nie zgadzam siƒô";

      if(v.h >= 0){
        btn.onclick = ()=>alert("Bez sensu üôÇ To jest na TwojƒÖ korzy≈õƒá. Od dodatnich punkt√≥w siƒô nie odwo≈Çuje.");
      } else {
        if(date !== dzis){
          btn.disabled = true;
          btn.title = "Odwo≈Çanie tylko w dniu przyznania punkt√≥w.";
        } else if(appeal){
          btn.disabled = true;
          btn.title = "Odwo≈Çanie ju≈º zosta≈Ço z≈Ço≈ºone (tylko raz na wpis).";
        } else {
          btn.onclick = ()=>odwolanie(date, logId, v);
        }
      }

      li.appendChild(btn);
      inner.appendChild(li);
    });

    ul.appendChild(inner);
  });
}

/* ================== USUWANIE ================== */
async function usunWpisDzis(date, logId, v){
  if(!rodzic) return alert("Najpierw zaloguj rodzica.");
  if(date !== dzis) return alert("Mo≈ºna usuwaƒá tylko dzisiejsze wpisy.");
  if(v.rodzic !== rodzic) return alert("Mo≈ºe usunƒÖƒá tylko autor wpisu.");

  if(!confirm("UsunƒÖƒá ten wpis? (tylko dzisiaj)")) return;

  await db.ref("dni/"+date).transaction(x=>(x||0) - (v.h||0));
  await db.ref("log/"+date+"/"+logId).remove();

  const idx = `${date}|${logId}`;
  const a = appealsByLog[idx];
  if(a && (a.status||"") === "pending"){
    await db.ref("odwolania/"+a.key).update({
      status:"cancelled",
      kto: rodzic,
      decyzjaAt: Date.now(),
      komentarz:"Wpis zosta≈Ç usuniƒôty przez autora wpisu."
    });
  }
}

/* ================== ODWO≈ÅANIA ================== */
async function odwolanie(date, logId, v){
  if(date !== dzis) return alert("Odwo≈Çanie tylko w dniu przyznania punkt√≥w.");
  if(v.h >= 0){
    alert("Od dodatnich punkt√≥w nie ma sensu siƒô odwo≈Çywaƒá üôÇ");
    return;
  }
  if(appealsByLog[`${date}|${logId}`]){
    alert("Odwo≈Çanie do tego wpisu ju≈º jest z≈Ço≈ºone (tylko raz na wpis).");
    return;
  }

  const why = prompt("Dlaczego siƒô nie zgadzasz? (min. 20 znak√≥w)");
  if(!why || why.trim().length < 20){
    alert("Za kr√≥tko. Napisz konkretnie (min. 20 znak√≥w).");
    return;
  }

  await db.ref("odwolania").push({
    data: date,
    logId: logId,
    h: v.h,
    opis: v.opis,
    powod: why.trim(),
    status: "pending",
    createdAt: Date.now(),
    deadlineDay: endOfNextDayDeadlineDay(),
    autorRodzic: v.rodzic || ""
  });

  alert("Odwo≈Çanie zapisane.");
}

async function processAutoAcceptAppeals(){
  const snap = await db.ref("odwolania").once("value");
  const nowIso = nowWarsawParts().isoDate;

  const jobs = [];
  snap.forEach(ch=>{
    const o = ch.val();
    if(!o) return;
    if(o.status !== "pending") return;
    if(!o.deadlineDay) return;
    if(nowIso <= o.deadlineDay) return;
    jobs.push({key: ch.key, o});
  });

  for(const j of jobs){
    const cur = (await db.ref("odwolania/"+j.key).once("value")).val();
    if(!cur || cur.status !== "pending") continue;

    const day = cur.data;
    await db.ref("dni/"+day).transaction(x=>(x||0) - (cur.h||0));

    await db.ref("odwolania/"+j.key).update({
      status: "accepted_auto",
      kto: "AUTO",
      decyzjaAt: Date.now(),
      komentarz: "Zaakceptowane automatycznie z powodu braku rozpatrzenia przez rodzica w umownym czasie."
    });
  }
}

/* ================== RODZIC: ODWO≈ÅANIA ================== */
function updateAppealsButton(){
  const btn = document.getElementById("btnAppeals");
  const badge = document.getElementById("appealsBadge");
  if(!btn || !badge) return;

  const pendingCount = appealsList.filter(a => (a.status||"") === "pending").length;
  badge.innerText = String(pendingCount);

  btn.classList.remove("btnGreen","btnRed");
  btn.classList.add(pendingCount > 0 ? "btnRed" : "btnGreen");
}

function renderParentAppeals(){
  const root = document.getElementById("odwolaniaRodzic");
  if(!root) return;
  root.innerHTML = "";

  if(appealsList.length === 0){
    const div = document.createElement("div");
    div.className = "muted";
    div.innerText = "Brak odwo≈Ça≈Ñ.";
    root.appendChild(div);
    return;
  }

  const nowIso = nowWarsawParts().isoDate;

  appealsList.forEach(o=>{
    const wrap = document.createElement("div");
    wrap.className = `box ${appealClass(o)}`;

    const st = statusLabelForAppeal(o);
    const deadlineTxt = o.deadlineDay ? `${o.deadlineDay} (do ko≈Ñca dnia)` : "-";
    const ktoTxt = o.kto ? `Decyzja: ${o.kto}` : "";
    const komTxt = o.komentarz ? o.komentarz : "";

    wrap.innerHTML = `
      <div><b>${escapeHtml(o.opis || "")}</b> <span class="tag">${escapeHtml(st)}</span></div>
      <div class="muted">Warto≈õƒá wpisu: <b>${o.h}</b> h ¬∑ Data wpisu: <b>${escapeHtml(o.data||"-")}</b> ¬∑ Autor wpisu: <b>${escapeHtml(o.autorRodzic||"-")}</b></div>
      <div style="margin-top:6px;"><i>Pow√≥d Julka:</i><br>${escapeHtml(o.powod||"")}</div>
      <div class="muted" style="margin-top:6px;">Termin decyzji: ${escapeHtml(deadlineTxt)}</div>
    `;

    if((o.status||"") === "pending"){
      const row = document.createElement("div");
      row.className = "row";
      row.style.marginTop = "8px";

      const ok = document.createElement("button");
      ok.innerText = "Uznaj (cofa wpis)";

      const no = document.createElement("button");
      no.innerText = "Odrzuƒá (zostaje)";

      const isAuthor = rodzic && (o.autorRodzic === rodzic);
      const inTime = !o.deadlineDay ? true : (nowIso <= o.deadlineDay);

      if(!rodzic){
        ok.disabled = true; no.disabled = true;
        ok.title = "Zaloguj siƒô jako rodzic.";
        no.title = "Zaloguj siƒô jako rodzic.";
      } else if(!isAuthor){
        ok.disabled = true; no.disabled = true;
        ok.title = "Mo≈ºe rozpatrzyƒá tylko autor wpisu.";
        no.title = "Mo≈ºe rozpatrzyƒá tylko autor wpisu.";
      } else if(!inTime){
        ok.disabled = true; no.disabled = true;
        ok.title = "Po terminie ‚Äì system auto-zaakceptuje.";
        no.title = "Po terminie ‚Äì system auto-zaakceptuje.";
      } else {
        ok.onclick = async ()=>{
          const cur = (await db.ref("odwolania/"+o.key).once("value")).val();
          if(!cur || cur.status !== "pending") return alert("To odwo≈Çanie ju≈º zosta≈Ço rozpatrzone.");

          await db.ref("dni/"+cur.data).transaction(x=>(x||0) - (cur.h||0));
          await db.ref("odwolania/"+o.key).update({
            status:"accepted",
            kto: rodzic,
            decyzjaAt: Date.now(),
            komentarz:"Zaakceptowane przez rodzica."
          });
        };

        no.onclick = async ()=>{
          const comment = prompt("Dlaczego odrzucasz? (min. 10 znak√≥w)","Odrzucone, bo...");
          if(!comment || comment.trim().length < 10){
            alert("Komentarz za kr√≥tki (min. 10 znak√≥w).");
            return;
          }
          const cur = (await db.ref("odwolania/"+o.key).once("value")).val();
          if(!cur || cur.status !== "pending") return alert("To odwo≈Çanie ju≈º zosta≈Ço rozpatrzone.");

          await db.ref("odwolania/"+o.key).update({
            status:"rejected",
            kto: rodzic,
            decyzjaAt: Date.now(),
            komentarz: comment.trim()
          });
        };
      }

      row.appendChild(ok);
      row.appendChild(no);
      wrap.appendChild(row);
    } else {
      const line = document.createElement("div");
      line.className = "muted";
      line.style.marginTop = "8px";
      line.innerText = [ktoTxt, komTxt].filter(Boolean).join(" ¬∑ ");
      wrap.appendChild(line);
    }

    root.appendChild(wrap);
  });
}

/* ================== ZAMKNIƒòCIE TYGODNIA ================== */
async function acquireCloseLock(){
  const lockRef = db.ref("meta/closeLock");
  const now = Date.now();
  const res = await lockRef.transaction(v=>{
    if(v && v.at && (now - v.at) < 2*60*1000) return;
    return { at: now };
  });
  return !!(res && res.committed);
}
async function releaseCloseLock(){
  await db.ref("meta/closeLock").remove();
}

async function closeWeekIfNotClosed(weekKey, reason, force){
  const got = await acquireCloseLock();
  if(!got) return;

  try{
    const metaRef = db.ref("meta/lastCloseWeekKey");
    const last = (await metaRef.once("value")).val();

    const dniSnap = await db.ref("dni").once("value");
    const dniHasData = dniSnap.exists();

    const inconsistent = (last === weekKey) && dniHasData;

    if((last === weekKey) && !force && !dniHasData && !inconsistent){
      const wv = (await db.ref("weekend").once("value")).val() || 0;
      await setWeekendSummary(wv, weekKey, reason || "already_closed");
      return;
    }

    let sum = 0;
    if(dniHasData){
      dniSnap.forEach(d=> sum += (d.val()||0));
    } else {
      sum = (await db.ref("weekend").once("value")).val() || 0;
    }

    await db.ref("weekend").set(sum);
    await setWeekendSummary(sum, weekKey, reason || "manual");

    if(dniHasData || inconsistent || force){
      await db.ref("dni").remove();
      await db.ref("log").remove();
    }

    await metaRef.set(weekKey);
    await db.ref("meta/lastCloseReason").set(reason || "");
    await db.ref("meta/lastCloseAt").set(Date.now());
  } finally {
    await releaseCloseLock();
  }
}

async function zamknijTydzien(){
  if(!confirm("ZamknƒÖƒá tydzie≈Ñ? To przepisze wynik na 'Weekend' i wyczy≈õci dni/logi.")) return;
  const wk = isoWeekKeyWarsaw();
  await closeWeekIfNotClosed(wk, "manual", true);
}

async function checkAutoClose(){
  const p = nowWarsawParts();
  const isFriday = (p.weekday || "").toLowerCase().startsWith("pt");
  if(!isFriday) return;

  const after18 = (p.hour > 18) || (p.hour === 18 && p.minute >= 0);
  if(!after18) return;

  const wk = isoWeekKeyWarsaw();
  await closeWeekIfNotClosed(wk, "auto_friday_18", false);
}

/* ================== RETENCJA ================== */
async function purgeOldData(){
  const cutoff = isoDateShift(nowWarsawParts().isoDate, -14);

  const dniSnap = await db.ref("dni").once("value");
  dniSnap.forEach(d=>{
    if(d.key && d.key < cutoff){
      db.ref("dni/"+d.key).remove();
    }
  });

  const logSnap = await db.ref("log").once("value");
  logSnap.forEach(day=>{
    if(day.key && day.key < cutoff){
      db.ref("log/"+day.key).remove();
    }
  });

  const odSnap = await db.ref("odwolania").once("value");
  odSnap.forEach(ch=>{
    const o = ch.val();
    const date = o && o.data;
    if(date && date < cutoff){
      db.ref("odwolania/"+ch.key).remove();
    }
  });
}

/* ================== RESET (TYLKO ADMIN KUBY) ================== */
async function resetAllDataFromAdmin(){
  if(rodzic !== "Kuba") return;

  if(!confirm("RESET: wyczy≈õci CA≈ÅƒÑ bazƒô. Na pewno?")) return;

  const pin = await askPinMasked("PIN (RESET wszystkich danych):");
  if(pin === null) return;
  if(pin !== "6978") return alert("Z≈Çy PIN. Reset anulowany.");

  await db.ref("dni").remove();
  await db.ref("log").remove();
  await db.ref("odwolania").remove();
  await db.ref("weekend").remove();
  await db.ref("meta").remove();

  alert("Wyczyszczone. Od≈õwie≈º stronƒô.");
  location.reload();
}

/* ================== TIMER ================== */
setInterval(()=>{
  purgeOldData();
  processAutoAcceptAppeals();
  checkAutoClose();
}, 60*1000);

purgeOldData();
processAutoAcceptAppeals();
checkAutoClose();

/* ================== HELPERS ================== */
function escapeHtml(str){
  return (str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}
function setText(id, val){
  const el = document.getElementById(id);
  if(el) el.innerText = String(val);
}
</script>

<!-- Tw√≥j updateBtn (SW) zostawiam bez zmian -->
<button id="updateBtn"
        style="position:fixed;bottom:10px;right:10px;
        background:#d4f8d4;border:2px solid #2e7d32;
        padding:10px;border-radius:10px;"
        disabled>
  Aplikacja aktualna
</button>

<script>
let newWorker;

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    window.location.reload();
  });

  navigator.serviceWorker.getRegistration().then(reg => {
    if (!reg) return;

    reg.addEventListener('updatefound', () => {
      newWorker = reg.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          const btn = document.getElementById('updateBtn');
          btn.disabled = false;
          btn.style.background = '#ffcccc';
          btn.style.borderColor = '#c62828';
          btn.innerText = 'Dostƒôpna aktualizacja ‚Äì kliknij';

          btn.onclick = () => {
            newWorker.postMessage({ action: 'skipWaiting' });
          };
        }
      });
    });
  });
}
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('SW zarejestrowany:', reg.scope))
      .catch(err => console.error('SW b≈ÇƒÖd:', err));
  });
}
</script>

</body>
</html>
