<!DOCTYPE html>
<html lang="pl">
<head><!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Zadania Julka">

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Punkty Julka</title>

<link rel="stylesheet" href="./css/style.css">
</head>

<body>

<!-- ===== BANER AKTUALIZACJI (PC) ===== -->
<div id="updateBanner" class="hidden">
  <span>ğŸ”„ Nowa wersja aplikacji â€“ odÅ›wieÅ¼</span>
  <button onclick="forceDesktopUpdate()">OdÅ›wieÅ¼ teraz</button>
</div>

<h1>
  Punkty Julka
  <span id="appVer" class="tag"></span>
</h1>

<!-- ===== START (DASHBOARD) ===== -->
<div id="login" class="box">
  <div class="muted">Wybierz kafelek:</div>

  <div class="dashWrap">
    <div class="tile tJulek" onclick="loginJulek()">
      <div class="tileIcon">ğŸ‘¦</div>
      <div class="tileTitle">Julek</div>
      <div class="tileDesc">PodglÄ…d punktÃ³w i odwoÅ‚ania</div>
    </div>

    <div class="tile tRodzic" onclick="loginRodzic()">
      <div class="tileIcon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦</div>
      <div class="tileTitle">Rodzic</div>
      <div class="tileDesc">Dodawanie/odejmowanie godzin</div>
    </div>
  </div>

  <div class="box adminNotesStandalone">
    <h3>ğŸ“Œ Notatki administratora</h3>
    <div id="adminNotesPublic" class="muted">
      Brak aktualnych notatek.
    </div>
  </div>

  <div class="dashWrap">
    <div class="tile tPdf" onclick="openPdf('UMOWA_JULEK_system_godzin.pdf')">
      <div class="tileIcon">ğŸ“„</div>
      <div class="tileTitle">Regulamin (PDF)</div>
      <div class="tileDesc">Do odczytu</div>
    </div>

    <div class="tile tPdf" onclick="openPdf('TABELA_PUNKTOW_JULEK.pdf')">
      <div class="tileIcon">ğŸ“Š</div>
      <div class="tileTitle">Tabela punktÃ³w (PDF)</div>
      <div class="tileDesc">Do odczytu</div>
    </div>

    <div class="tile tPdf" onclick="openPdf('Instrukcja_obsÅ‚ugi.pdf')">
      <div class="tileIcon">ğŸ“˜</div>
      <div class="tileTitle">Instrukcja obsÅ‚ugi</div>
      <div class="tileDesc">PDF â€“ jak dziaÅ‚a program</div>
    </div>
  </div>

  <div class="muted" style="margin-top:12px;">
    PINy dziaÅ‚ajÄ… lokalnie w tej stronie. RESET jest tylko w zmianach administracyjnych Kuby.
  </div>
</div>

<!-- PIN modal (maskowane) -->
<div id="pinModal" class="modalOverlay hidden" hidden>
  <div class="modalCard">
    <div id="pinTitle" class="modalTitle">PIN</div>
    <div class="modalHint">Wpis jest maskowany (gwiazdki).</div>
    <input id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
    <div class="modalActions">
      <button id="pinCancel" class="smallbtn">Anuluj</button>
      <button id="pinOk" class="smallbtn">OK</button>
    </div>
  </div>
</div>

<!-- ================= PANEL RODZIC ================= -->
<div id="rodzic" class="panel">

  <div class="box">
    <div><b>Zalogowany rodzic:</b> <span id="rodzicName"></span></div>

    <div class="weekSummaryBig" style="margin-top:10px;">
      <div>DziÅ›: <b><span id="todayR">0</span> h</b></div>
      <div>TydzieÅ„: <b><span id="weekR">0</span> h</b></div>
      <div>Weekend: <b><span id="weekendR">0</span> h</b></div>
    </div>

    <div class="row" style="margin-top:8px;">
      <button id="btnAdmin" class="hidden" onclick="openAdmin()">Zmiany administracyjne</button>
      <span class="muted">Auto-zamkniÄ™cie: piÄ…tek 18:00 (Warszawa) â€” wykona siÄ™, gdy ktoÅ› ma otwartÄ… apkÄ™ albo wejdzie po czasie.</span>
    </div>
  </div>

  <div class="box">
    <h3>Menu</h3>
    <div class="row">
      <button onclick="showSection('secUzn')">Godziny uznaniowe</button>
      <button onclick="showSection('secOceny')">Oceny</button>
      <button onclick="showSection('secObow')">ObowiÄ…zki i zachowanie</button>
      <button onclick="showSection(null)">ZwiÅ„ wszystko</button>

      <button id="btnAppeals" class="btnGreen" onclick="toggleAppeals()">
        OdwoÅ‚ania i historia <span id="appealsBadge" class="tag">0</span>
      </button>

      <button id="btnPointRequests" class="btnGreen" onclick="showSection('secPointReq')">
        Wnioski o punkty <span id="pointReqBadge" class="tag">0</span>
      </button>
    </div>

    <div id="weekendInfoParent" class="weekInfo hidden">
      <div id="weekendInfoTextParent" class="weekMsgText"></div>
      <div id="weekendInfoDateParent" class="muted"></div>
    </div>
  </div>

  <div id="secAdmin" class="box adminBox hidden">
    <div class="adminTitleRow">
      <h3 style="margin:0;">Zmiany administracyjne</h3>
      <span class="muted">DostÄ™p tylko dla Kuby (PIN wymagany przy wejÅ›ciu).</span>
    </div>

    <hr>

    <h3>Notatki administratora</h3>

    <textarea id="adminNoteInput"
      placeholder="Wpisz notatkÄ™ widocznÄ… na ekranie logowania..."
      style="width:100%;min-height:80px;padding:10px;border-radius:10px;"></textarea>

    <div class="row" style="margin-top:8px;">
      <button onclick="addAdminNote()" class="btnGreen">Dodaj notatkÄ™</button>
    </div>

    <div id="adminNotesAdmin" style="margin-top:12px;"></div>

    <hr>

    <h3>Korekta godzin (rÄ™czna)</h3>

    <div class="box" style="max-width:520px;">
      <div class="row" style="align-items:center;gap:10px;">
        <button id="adminAdjMinus" class="smallbtn">âˆ’</button>

        <div id="adminAdjValue"
             style="min-width:110px;text-align:center;font-weight:bold;font-size:18px;
                    padding:6px 10px;border-radius:10px;border:2px solid #2e7d32;background:#fff;">
          0 h
        </div>

        <button id="adminAdjPlus" class="smallbtn">+</button>

        <button id="adminAdjConfirm" class="btnGreen">ZatwierdÅº</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        Godziny zmieniasz tylko przyciskami + / âˆ’. Po â€ZatwierdÅºâ€ ma wyskoczyÄ‡ okno na komentarz i zapis do logu (to zrobimy w admin.js).
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button onclick="zamknijTydzien()">Zamknij tydzieÅ„</button>
      <button class="btnRed" onclick="resetAllDataFromAdmin()">RESET (start od zera)</button>
      <button class="btnGreen" onclick="saveAndCloseAdmin()">Zapisz i zamknij zmiany administracyjne</button>
    </div>

    <div class="muted" style="margin-top:8px;">
      RESET jest dostÄ™pny tylko tutaj. Dodatkowo wymaga ponownego PINu Kuby.
    </div>
  </div>

  <div id="secUzn" class="box hidden">
    <h3>Godziny uznaniowe (komentarz obowiÄ…zkowy)</h3>
    <div class="row">
      <button onclick="uzn(1)">+1h</button>
      <button onclick="uzn(2)">+2h</button>
      <button onclick="uzn(-1)">-1h</button>
      <button onclick="uzn(-2)">-2h</button>
    </div>
    <div class="muted">Po klikniÄ™ciu musisz wpisaÄ‡: za co.</div>
  </div>

  <div id="secOceny" class="box hidden">
    <h3>Oceny</h3>

    <div class="box">
      <h3 style="margin-top:0;">Polski</h3><div id="polski"></div>
      <h3>Biologia</h3><div id="biologia"></div>
      <h3>Geografia</h3><div id="geografia"></div>
    </div>

    <div class="box">
      <h3 style="margin-top:0;">WF</h3><div id="wf"></div>
      <h3>Technika</h3><div id="technika"></div>
      <h3>Muzyka</h3><div id="muzyka"></div>
      <h3>Informatyka</h3><div id="informatyka"></div>
      <h3>Plastyka</h3><div id="plastyka"></div>
    </div>

    <div class="box">
      <h3 style="margin-top:0;">Matematyka</h3><div id="matematyka"></div>
      <h3>Angielski</h3><div id="angielski"></div>
      <h3>Niemiecki</h3><div id="niemiecki"></div>
      <h3>Historia</h3><div id="historia"></div>
    </div>

    <div class="muted">Tu dziaÅ‚a ostrzeÅ¼enie, jeÅ›li drugi rodzic juÅ¼ daÅ‚ punkty za ten sam przedmiot i ocenÄ™ tego samego dnia.</div>
  </div>

  <div id="secObow" class="box hidden">
    <h3>ObowiÄ…zki / Zachowanie (komentarz opcjonalny)</h3>
    <div class="row">
      <button onclick="obow( 1,'ObowiÄ…zki zrobione', 'obow_ok', false)">ObowiÄ…zki zrobione +1h</button>

      <button onclick="obow( 4,'Pozytywna uwaga w szkole', 'uwaga_pos', false)">Pozytywna uwaga w szkole +4h</button>
      <button onclick="obow(-4,'Negatywna uwaga w szkole', 'uwaga_neg', false)">Negatywna uwaga w szkole -4h</button>

      <button onclick="obow(-2,'ObowiÄ…zki niezrobione', 'obow_no', false)">ObowiÄ…zki niezrobione -2h</button>
      <button onclick="obow(-10,'Oszustwo', 'oszustwo', false)">Oszustwo -10h</button>

      <button onclick="obow(-5,'Bicie / obraÅ¼anie MichaÅ‚a', 'agresja', true)">Bicie/obraÅ¼anie MichaÅ‚a -5h</button>
      <button onclick="obow(-2,'Brak higieny', 'higiena', true)">Brak higieny -2h</button>
      <button onclick="obow(-2,'PorzÄ…dek w pokoju niezrobiony', 'pokoj', true)">PorzÄ…dek w pokoju -2h</button>
    </div>
    <div class="muted">Komentarz opcjonalny: po klikniÄ™ciu moÅ¼esz dopisaÄ‡ szczegÃ³Å‚. Dublety sprawdzamy tylko dla agresji/higieny/pokoju.</div>
  </div>

  <div class="box">
    <h3>Aktualny tydzieÅ„ â€“ log (rodzic)</h3>
    <button class="smallbtn" onclick="toggleWeekLogs()">PozostaÅ‚e dni tygodnia</button>

    <div class="muted">Usuwanie: tylko wpisy z dzisiaj i tylko autor wpisu (drugi rodzic ma przycisk nieaktywny).</div>
    <ul id="logR"></ul>
  </div>

  <div id="secPointReq" class="box hidden">
    <h3>Wnioski o punkty (rodzic)</h3>
    <div class="muted">Tu pojawiÄ… siÄ™ wnioski Julka wraz z przyciskami â€Zaakceptuj / OdrzuÄ‡â€.</div>
    <div id="pointReqRodzic"></div>
  </div>

  <div id="secAppeals" class="box hidden">
    <h3>OdwoÅ‚ania Julka (rodzic) + historia</h3>
    <div class="muted">Decyzja do koÅ„ca nastÄ™pnego dnia. Po terminie odwoÅ‚anie auto-zaakceptowane.</div>
    <div id="odwolaniaRodzic"></div>
  </div>

</div>

<!-- ================= PANEL JULEK ================= -->
<div id="julek" class="panel">
  <div class="box">
    <div class="julekSummaryRow">
      <div class="julekKpi">
        <div class="julekKpiLabel">DziÅ›</div>
        <div class="julekKpiVal"><span id="todayJ">0</span>h</div>
      </div>
      <div class="julekKpi">
        <div class="julekKpiLabel">TydzieÅ„</div>
        <div class="julekKpiVal"><span id="weekJ">0</span>h</div>
      </div>
      <div class="julekKpi">
        <div class="julekKpiLabel">Weekend</div>
        <div class="julekKpiVal"><span id="weekendJ">0</span>h</div>
      </div>
    </div>
  </div>

  <div id="weekendInfoJulek" class="box hidden">
    <div id="weekendInfoTextJulek" class="weekMsgTextBig"></div>
    <div id="weekendInfoDateJulek" class="muted"></div>
  </div>

  <div class="box">
    <h3>Aktualny tydzieÅ„ â€“ za co</h3>

    <div class="row" style="margin-bottom:8px;">
      <button class="btnGreen" onclick="wniosekOPunkt()">Wniosek o punkt</button>
      <button class="smallbtn" onclick="toggleWeekLogs()">PozostaÅ‚e dni tygodnia</button>
    </div>

    <ul id="logJ"></ul>
    <div class="muted">OdwoÅ‚anie: tylko od punktÃ³w ujemnych, tylko w dniu przyznania i tylko raz na wpis.</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script src="./js/time.js"></script>
<script src="./js/auth.js"></script>
<script src="./js/state.js"></script>
<script src="./js/render.js"></script>
<script src="./js/app.js"></script>
<script src="./js/parent.js"></script>
<script src="./js/child.js"></script>
<script src="./js/admin.js"></script>

<!-- SW update button -->
<button id="updateBtn"
        style="position:fixed;bottom:10px;right:10px;
        background:#d4f8d4;border:2px solid #2e7d32;
        padding:10px;border-radius:10px;"
        disabled>
  Aplikacja aktualna
</button>

<script>
let newWorker;

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    window.location.reload();
  });

  navigator.serviceWorker.getRegistration().then(reg => {
    if (!reg) return;

    reg.addEventListener('updatefound', () => {
      newWorker = reg.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          const btn = document.getElementById('updateBtn');
          btn.disabled = false;
          btn.style.background = '#ffcccc';
          btn.style.borderColor = '#c62828';
          btn.innerText = 'DostÄ™pna aktualizacja â€“ kliknij';

          btn.onclick = () => {
            newWorker.postMessage({ action: 'skipWaiting' });
          };
        }
      });
    });
  });
}
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('SW zarejestrowany:', reg.scope))
      .catch(err => console.error('SW bÅ‚Ä…d:', err));
  });
}
</script>

</body>
</html>
